// new index (1).html (Ø¯Ø§Ø®Ù„ ÙˆØ³Ù… <script>)
// (ÙŠØ¬Ø¨ ØªØ¹Ø±ÙŠÙ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØºÙŠØ± ÙÙŠ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ù„ÙˆÙŠ Ù„Ù…Ù„Ù JS)
let appliedCodeId = null; 

// ===================================
// ğŸ« Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ (Player Flow)
// ===================================

window.validateVoucher = async function(fieldId) {
    const codeValue = document.getElementById('voucherCodeInput').value.trim();
    const resultContainer = document.getElementById('voucherResult');
    
    if (!codeValue) {
        resultContainer.innerHTML = '';
        appliedCodeId = null;
        // ÙŠØ¬Ø¨ Ù‡Ù†Ø§ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø¬Ø² ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
        return; 
    }
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
    window.showLoading(true);

    try {
        const response = await apiRequest("/api/codes/validate", 'POST', { 
            codeValue, 
            fieldId 
        });

        appliedCodeId = response.codeId;
        window.showLoading(false);
        
        let discountText = '';
        if (response.discountType === 'percent') {
            discountText = `Ø®ØµÙ…: ${response.discountValue}%`;
        } else if (response.discountType === 'fixed') {
            discountText = `Ø®ØµÙ…: ${response.discountValue} Ø¬.Ù…`;
        }
        
        resultContainer.innerHTML = `
            <div class="alert alert-success p-2 small m-0">
                âœ… ${response.message} (${discountText})
            </div>
        `;
        // ÙŠØ¬Ø¨ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø¬Ø² ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…
        updateBookingSummary(response); 

    } catch (error) {
        window.showLoading(false);
        appliedCodeId = null;
        resultContainer.innerHTML = `
            <div class="alert alert-danger p-2 small m-0">
                âŒ ${error.message || 'Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ§Ù„Ø­.'}
            </div>
        `;
        updateBookingSummary(null);
    }
}

// ===================================
// âš½ ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ø¬Ø² (bookStadium)
// ===================================
// ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù…Ø¹Ø±Ù Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ø·Ø¨Ù‚ Ù…Ø¹ Ø·Ù„Ø¨ Ø§Ù„Ø­Ø¬Ø²

window.bookStadium = async function(fieldId, bookingDate, startTime, endTime) {
    // ... (Ø¬Ù„Ø¨ playersNeeded)
    
    const data = {
        fieldId,
        bookingDate,
        startTime,
        endTime,
        playersNeeded,
        codeId: appliedCodeId // <-- Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø±Ù Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø°ÙŠ ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù†Ù‡
    };
    
    // ... (Ø¨Ù‚ÙŠØ© Ù…Ù†Ø·Ù‚ bookStadiumController Ø§Ù„Ø°ÙŠ ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡ Ø³Ø§Ø¨Ù‚Ø§Ù‹)
    try {
        const response = await apiRequest("/api/booking/request", 'POST', data);
        // ... (Ù…Ù†Ø·Ù‚ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„Ù„Ø¯ÙØ¹ Ø£Ùˆ Ø¹Ø±Ø¶ Ø§Ù„ØªØ£ÙƒÙŠØ¯)
    } catch (error) {
        // ...
    }
}

// Ù…Ù„Ø§Ø­Ø¸Ø©: ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ (voucherCodeInput) ÙˆÙˆØ¹Ø§Ø¡ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ (voucherResult) ÙˆØ²Ø± Ø§Ù„ØªØ­Ù‚Ù‚ ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†.

// new index (1).html (Ø¯Ø§Ø®Ù„ ÙˆØ³Ù… <script>)
// (ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ù„Ø© apiRequest ÙÙŠ Ù†Ø·Ø§Ù‚ Ø§Ù„ÙˆØµÙˆÙ„)

/**
 * ØªØ¨Ø¯Ø£ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø¬Ø² ÙˆØªØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø§Ø¬Ø© Ù„Ø¯ÙØ¹ Ø¹Ø±Ø¨ÙˆÙ†
 * ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø³Ø§Ø¹Ø© Ù…ØªØ§Ø­Ø©
 */
window.bookStadium = async function(fieldId, bookingDate, startTime, endTime) {
    // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¯Ø§Ù„ (Modal) Ù‡Ù†Ø§ Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
    // (Ø³Ù†ÙØªØ±Ø¶ ÙˆØ¬ÙˆØ¯ Ø¹Ù†ØµØ± Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ø¥Ø¶Ø§ÙÙŠÙŠÙ†)
    const playersNeededInput = document.getElementById('playersNeededInput');
    const playersNeeded = playersNeededInput ? parseInt(playersNeededInput.value) || 0 : 0; 
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
    window.showLoading(true); 

    try {
        const response = await apiRequest("/api/booking/request", 'POST', {
            fieldId,
            bookingDate,
            startTime,
            endTime,
            playersNeeded
        });

        window.showLoading(false);
        
        if (response.requiresPayment) {
            // ØªÙˆØ¬ÙŠÙ‡ Ù„ØµÙØ­Ø© Ø§Ù„Ø¯ÙØ¹ Ù„Ø¯ÙØ¹ Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ†
            window.showToast("ØªÙ… Ø­Ø¬Ø² Ø§Ù„Ø³Ø§Ø¹Ø© Ù…Ø¨Ø¯Ø¦ÙŠØ§Ù‹. Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„Ù„Ø¯ÙØ¹...", 'info');
            // ØªØ£ÙƒØ¯ Ø£Ù† /payment.html Ù‡Ùˆ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ØµØ­ÙŠØ­
            setTimeout(() => {
                window.location.href = `/payment.html?bookingId=${response.bookingId}`;
            }, 1000);
        } else {
            // Ø­Ø¬Ø² Ù…Ø¹Ù„Ù‚ Ù„Ø§ ÙŠØ­ØªØ§Ø¬ Ø¯ÙØ¹ Ø¹Ø±Ø¨ÙˆÙ† (Ø£Ù‚Ù„ Ù…Ù† 24 Ø³Ø§Ø¹Ø©)
            window.showToast(response.message, 'info');
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù„Ø¹Ø¨ Ù„Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© "Pending" Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            // (ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† loadStadiumDetails Ù…ÙØ¹Ø±Ù‘ÙØ© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù)
            loadStadiumDetails(fieldId); 
        }
    } catch (error) {
        window.showLoading(false);
        window.showToast(`ÙØ´Ù„ Ø§Ù„Ø­Ø¬Ø²: ${error.message}`, 'error');
    }
}
// ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø§Ù„Ø© Ø¥Ù„Ù‰ appHelpers Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ³ØªØ®Ø¯Ù… Ù†Ù…Ø· Ø§Ù„ØªØµØ¯ÙŠØ± Ù‡Ø°Ø§
if (window.appHelpers) {
    window.appHelpers.bookStadium = window.bookStadium;
}

// new index (1).html (Ø¯Ø§Ø®Ù„ Ø¯Ø§Ù„Ø© showStadiumPopup)

async function showStadiumPopup(stadiumId) {
    // ... Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù„Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù„Ø¹Ø¨ ÙˆØ§Ù„Ø³Ø§Ø¹Ø§Øª ...
    
    // =====================================
    // ğŸ†• Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ù…Ù„Ø¹Ø¨
    // =====================================
    const ratingsContainer = document.getElementById('popupRatings');
    const avgRatingElement = document.getElementById('popupAvgRating');
    
    try {
        const ratingsResponse = await fetch(`/api/fields/${stadiumId}/ratings`);
        if (!ratingsResponse.ok) throw new Error('ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª');
        
        const ratings = await ratingsResponse.json();
        
        // Ø¬Ù„Ø¨ Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ù…Ù† ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù„Ø¹Ø¨ Ø§Ù„ØªÙŠ ØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ù…Ø³Ø¨Ù‚Ø§Ù‹
        // (ÙŠÙØªØ±Ø¶ Ø£Ù† ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù„Ø¹Ø¨ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ average_rating)
        const avgRating = stadiumDetails.average_rating ? parseFloat(stadiumDetails.average_rating).toFixed(1) : 'Ø¬Ø¯ÙŠØ¯';
        
        avgRatingElement.innerHTML = `â­ ${avgRating} <small class="text-muted">(${ratings.length} ØªÙ‚ÙŠÙŠÙ…)</small>`;

        ratingsContainer.innerHTML = ratings.map(r => `
            <div class="rating-item mb-2 p-2 border-bottom">
                <p class="mb-0">
                    <strong class="text-dark">${r.reviewer_name}:</strong> 
                    <span class="badge bg-warning">${'â­'.repeat(r.rating_value)}</span>
                </p>
                <small class="text-muted">${r.comment || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ‚.'}</small>
            </div>
        `).join('');
        
    } catch (error) {
        ratingsContainer.innerHTML = '<p class="text-danger small">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª.</p>';
        avgRatingElement.innerHTML = 'â­ N/A';
    }

    // ... Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø© ...
}
